name: AI Agent Runner

on:
  workflow_dispatch:
    inputs:
      agent_type:
        description: 'Type of AI agent to run'
        required: true
        type: choice
        options:
          - code-reviewer
          - test-generator
          - documentation-writer
          - bug-fixer
          - performance-optimizer
      target_path:
        description: 'Target file or directory path'
        required: true
        type: string
      model:
        description: 'AI model to use'
        required: false
        default: 'gpt-4'
        type: choice
        options:
          - gpt-4
          - gpt-4-turbo
          - claude-3-opus
          - gemini-pro
  repository_dispatch:
    types: [ai-agent-trigger]
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

jobs:
  run-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install AI agent dependencies
        run: |
          pip install openai anthropic google-generativeai
          pip install langchain langchain-openai
          pip install -r requirements-ai-agents.txt
      
      - name: Run ${{ github.event.inputs.agent_type || 'auto' }} Agent
        env:
          AGENT_TYPE: ${{ github.event.inputs.agent_type || 'code-reviewer' }}
          TARGET_PATH: ${{ github.event.inputs.target_path || '.' }}
          MODEL: ${{ github.event.inputs.model || 'gpt-4' }}
        run: |
          python scripts/ai-agents/runner.py \
            --agent-type "$AGENT_TYPE" \
            --target "$TARGET_PATH" \
            --model "$MODEL" \
            --output-format json
      
      - name: Create Pull Request with Agent Changes
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'AI Agent: ${{ github.event.inputs.agent_type }} updates'
          title: '[AI Agent] ${{ github.event.inputs.agent_type }} - Automated Improvements'
          body: |
            ## AI Agent Report
            
            **Agent Type:** ${{ github.event.inputs.agent_type }}
            **Model Used:** ${{ github.event.inputs.model }}
            **Target Path:** ${{ github.event.inputs.target_path }}
            
            This PR was automatically generated by the AI Agent Runner workflow.
            
            ### Changes Made:
            - Review the diff for detailed changes
            - All changes have been validated by the AI agent
            
            **Please review carefully before merging.**
          branch: ai-agent/${{ github.event.inputs.agent_type }}-${{ github.run_number }}
          delete-branch: true
      
      - name: Upload agent logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ai-agent-logs-${{ github.run_number }}
          path: logs/ai-agents/
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "AI Agent run failed. Check logs for details."
          # Add Slack/Discord notification here

  scheduled-maintenance:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run all maintenance agents
        run: |
          echo "Running scheduled AI agent maintenance..."
          # Code review for recent commits
          # Documentation updates
          # Performance optimization checks
